{% extends "castle/page_with_sidebar.html" %}
{%comment%}
This file is part of Ficlatt√©.
Copyright (C) 2015 Paul Robertson

    This program is free software: you can redistribute it and/or modify
    it under the terms of version 3 of the GNU Affero General Public
    License as published by the Free Software Foundation
    

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
{%endcomment%}
{% load staticfiles %}
{% load castle_tags %}

{% block secondary_panel %}

  {%comment%}------------------------------------------------------------------{%endcomment%}
  {%comment%} User dashboard {%endcomment%}
  {%comment%}------------------------------------------------------------------{%endcomment%}
  {% if user_dashboard %}
    {% if profile %}
      {% if prompt_button %}
          <div class="panel panel-info">
            <div class="panel-heading">
              <h3 class="panel-title">Prompts</h3>
            </div> <!-- id="" class="panel-heading" -->
            <div class="panel-body">
              <a class="btn btn-success btn-block" href="/prompts/new/" id="new-prompt-link" type="button"><span class="glyphicon glyphicon-pencil"></span> &nbsp; Write a prompt</a>
            </div> <!-- id="" class="panel-body" -->
          </div> <!-- id="" class="panel panel-info" -->
      {% endif %}
      
      {% if challenge_button %}
          <div class="panel panel-info">
            <div class="panel-heading">
              <h3 class="panel-title">Challenges</h3>
            </div> <!-- id="" class="panel-heading" -->
            <div class="panel-body">
              <a class="btn btn-success btn-block" href="/challenges/new/" id="new-challenge-link" type="button"><span class="glyphicon glyphicon-pencil"></span> &nbsp; Create a challenge</a>
            </div> <!-- id="" class="panel-body" -->
          </div> <!-- id="" class="panel panel-info" -->
      {% endif %}

          <div class="panel panel-warning">
            <div class="panel-heading">
              <h3 class="panel-title">User dashboard</h3>
            </div> <!-- id="" class="panel-heading" -->
            <div class="panel-body">
              <p><span class="glyphicon glyphicon-user"></span>
              <a href="/authors/u/profile/">Edit profile</a></p>
              <p><span class="glyphicon glyphicon-camera"></span>
              <a href="{% url 'avatar_upload' %}">Upload avatar</a></p>
              {% if perms.castle.post_blog %}<p><span class="glyphicon glyphicon-pencil"></span>
              <a href="/blog/new/">New blog</a></p>{% endif %}

              <hr />
              <h4>Your desk</h4>
              <ul class="list-unstyled">
                <li><a href="/stories/new/">Write a new story</a></li>
                <li><a href="/authors/u/drafts/">Drafts</a> <span>{{profile|num_drafts}}</span></li>
              </ul>
              <h4>Your library</h4>
              <ul class="list-unstyled">
                <li><a href="/authors/{{profile.pen_name|url}}/">Published stories</a> <span>{{profile|num_stories}}</span></li>
                <li><a href="/authors/u/prompts/">Published prompts</a> <span>{{profile|num_prompts}}</span></li>
                <li><a href="/authors/u/challenges/">Challenges offered</a> <span>{{profile|num_challenges}}</span></li>
              </ul>
              <hr />
              <h4>Friends: <span>{{profile|num_friends}}</span></h4>
              <div class="friends-grid-outer">
                {% for f in profile.friends.all %}
                  <div class="friends-grid-box"><div class="friends-grid-pic">
                  {{f|user_icon}}
                  </div></div>
                {% endfor %}
              </div> <!-- id="" class="friends-grid-outer" -->
              <hr />
              <h4>Followers: <span>{{profile|num_followers}}</span></h4>
              <div class="friends-grid-outer">
                {% for f in profile.followers.all %}
                  <div class="friends-grid-box"><div class="friends-grid-pic">
                  {{f|user_icon}}
                  </div></div>
                {% endfor %}
              </div> <!-- id="" class="friends-grid-outer" -->
            </div> <!-- id="" class="panel-body" -->
          </div> <!-- id="" class="panel panel-warning" -->
    {% endif %}
  {% endif %}

  {%comment%}------------------------------------------------------------------{%endcomment%}
  {%comment%} Panel for a different user {%endcomment%}
  {%comment%}------------------------------------------------------------------{%endcomment%}
  {% if other_user_sidepanel %}
    {% if author %}
          <div class="panel panel-warning">
            <div class="panel-heading">
              <h3 class="panel-title">{{author.pen_name}}</h3>
            </div> <!-- id="" class="panel-heading" -->
            <div class="panel-body">
              {% if is_friend %}
              <a class="btn btn-info btn-block" href="/friendship/del/{{author.id}}/" id="make-link" type="button">Un-follow {{author.pen_name}}</a>
              {% else %}
              <a class="btn btn-success btn-block" href="/friendship/add/{{author.id}}/" id="make-link" type="button">Follow {{author.pen_name}}</a>
              {% endif %}
              <hr />
              <h4>Friends <span>{{author|num_friends}}</span></h4>
              <div class="row">
                {% for f in author.friends.all %}
                <div class="col-md-3">
                  {{ f|user_icon }}
                </div> <!-- id="" class="col-md-3" -->
                {% endfor %}
              </div> <!-- id="" class="row" -->
              <hr />
              <h4>Followers <span>{{author|num_followers}}</span></h4>
              <div class="row">
                {% for f in author.followers.all %}
                <div class="col-md-3">
                  {{ f|user_icon }}
                </div> <!-- id="" class="col-md-3" -->
                {% endfor %}
              </div> <!-- id="" class="row" -->
            </div> <!-- id="" class="panel-body" -->
          </div> <!-- id="" class="panel panel-warning" -->
    {% endif %}
  {% endif %}
  
  {%comment%}------------------------------------------------------------------{%endcomment%}
  {%comment%} Story side-panel {%endcomment%}
  {%comment%}------------------------------------------------------------------{%endcomment%}
  {% if story_sidepanel %}
	
	{% if story.challenge and ch_owner and story.challenge.ended and not story.challenge.winner and not owner %}
			<form accept-charset="utf-8" action="/challenges/{{story.challenge.id}}/winner/{{story.id}}/" class="form-horizontal" id="winner-select-form" method="POST" role="form">
              {% csrf_token %}
              <input name="sid" type="hidden" value="{{story.id}}" />
              <input name="chid" type="hidden" value="{{story.challenge.id}}" />
			  <button class="btn btn-success btn-block" id="winner-select" type="submit"><span class="glyphicon glyphicon-bookmark"></span> Select as winner</button>
			</form>
    {% endif %}
    {% if owner %}
          <a class="btn btn-info btn-block" href="/stories/edit/{{story.id}}/" id="edit-link" type="button"><span class="glyphicon glyphicon-pencil"></span> Edit story</a>
          <a class="btn btn-danger btn-block" href="/stories/delete/{{story.id}}/" id="delete-link" onclick="return confirm('Are you sure you want to delete this story? (there is no undelete function)');" type="button"><span class="glyphicon glyphicon-trash"></span> Delete story</a>
    {% endif %}
    {% if story.tag_set.count > 0 or story.prompt or story.challenge or story.prequel_to or story.sequel_to %}
          <div class="well well-sm" id="inspiration">
    {% if story.prompt %}
            <h4>Story prompt:</h4>
            {{story.prompt.body|encode_story}}
            <p>{{story.prompt|prompt_link}} by {{story.prompt.user|author_link}}</p>
    {% endif %}
    {% if story.prompt_text %}
            <h4>Author's prompt text:</h4>
            {{story.prompt_text}}
    {% endif %}
    {% if story.challenge %}
            <h4>Story challenge:</h4>
            {{story.challenge.body|encode_story}}
            <p>{{story.challenge|challenge_link}} by {{story.challenge.user|author_link}}</p>
    {% endif %}
    {% if story.prequel_to %}
            {% if story.prompt %}<hr>{% endif %}
            <h4>Inspired by (prequel to)</h4>
            {{story.prequel_to.body|small_snippet}}
            <small>
              {{stories.prequel_to|story_link}}
              <br />
              {{story.prequel_to.user|author_span}}
            </small>
    {% endif %}
    {% if story.sequel_to %}
            {% if story.prompt or story.prequel_to %}<hr>{% endif %}
            <h4>Inspired by (sequel to)</h4>
            {{story.sequel_to.body|small_snippet}}
            <small>
              {{story.sequel_to|story_link}}
              <br />
              {{story.sequel_to.user|author_span}}
            </small>
    {% endif %}
    {% if story.tag_set.count > 0 %}
            {% if story.prompt or story.prequel_to or story.sequel_to %}<hr>{% endif %}
            <p>This story&#39;s tags are</p>
            <div class="tag-cloud" id="tags">
              {% for t in story.tag_set.all %}
              <a class="btn btn-primary btn-xs" href="/tags/{{t.tag|iriencode}}/" rel="tag" type="button">{{t.tag}}</a>
              {% endfor %}
            </div> <!-- id="tags" class="tag-cloud" -->
    {% endif %}
          </div> <!-- id="inspiration" class="well well-sm" -->
    {% endif %}
          <ul class="list-unstyled" id="story-stats">
    {% if story.draft %}
            <li id="mtime">Edited <abbr title="{{story.mtime|date:'Y-m-d'}}">{{story.mtime|age}}</abbr>. </li>
    {% else %}
            <li id="ptime">Published <abbr title="{{story.ptime|date:'Y-m-d'}}">{{story.ptime|age}}</abbr>. </li>
	   {% if story.ftime %}<li id="ftime">Featured <abbr title="{{story.ftime|date:'Y-m-d'}}">{{story.ftime|age}}. </li>{% endif %}
    {% endif %}
            <li id="num-ratings">Story viewed {{viewed}} times and rated {{rated}} times.</li>
          </ul>
    {% if profile %}
          <hr />
      {% if subscribed %}
          <p><a href="{% url 'story-unsub' story.id %}">Unsubscribe from e-mail notifications on this story</a></p>
      {% else %}
          <p><a href="{% url 'story-sub' story.id %}">Send me e-mail notifications of comments</a></p>
      {% endif %}
    {% endif %}
    {% if story.challenge and story == story.challenge.winner %}
		  <hr />
		  <h4>Challenge winner! <span class="glyphicon glyphicon-flag" style="color:red"></span></h4>
		  <ul class="challenge-story-winner">
				<li>Challenge: {{story.challenge|challenge_link}}
		  </ul>
    {% endif %}
          <hr />
          <p class="small" id="licence">All stories on Ficlatt&eacute; are licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">Creative Commons Attribution-Share Alike 3.0 License</a>. <a href="http://wiki.creativecommons.org/Sharing_Creative_Works">What does this mean?</a></p>
  {% endif %}
  {%comment%}------------------------------------------------------------------{%endcomment%}
  {%comment%} Prompt side panel {%endcomment%}
  {%comment%}------------------------------------------------------------------{%endcomment%}
  {% if prompt_sidepanel and prompt %}
          <a class="btn btn-success btn-block" href="/stories/new?prid={{prompt.id}}" id="prompt-link" type="button"><span class="glyphicon glyphicon-pencil"></span> Take prompt</a>
          {% if owner %}
          <!-- <a class="btn btn-info btn-block" href="/prompts/edit/{{prompt.id}}/" id="prompt-link" type="button"><span class="glyphicon glyphicon-pencil"></span> Edit prompt</a> -->
          {% endif %}
          <ul class="list-unstyled" id="story-stats">
            <li id="pubdate"><small>Prompt published {{prompt.ctime|date:"jS F Y"}}</small></li>
          </ul>
          <hr />
          <p class="small" id="licence">All prompts on Ficlatt&eacute; are licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">Creative Commons Attribution-Share Alike 3.0 License</a>. <a href="http://wiki.creativecommons.org/Sharing_Creative_Works">What does this mean?</a></p>
  {% endif %}
  {%comment%}------------------------------------------------------------------{%endcomment%}
  {%comment%} Challenge side panel {%endcomment%}
  {%comment%}------------------------------------------------------------------{%endcomment%}
  {% if challenge_sidepanel and challenge %}
	  {% if not challenge.started %}
		  <span class="btn btn-success btn-block ch_before" id="challenge-link" type="button"><span class="glyphicon glyphicon-time"></span> Challenge hasn't begun</span>
	  {% elif challenge.ended %}
		  <span class="btn btn-success btn-block ch_after" id="challenge-link" type="button"><span class="glyphicon glyphicon-hourglass"></span> Challenge complete</span>
	  {% else %}		  
          <a class="btn btn-success btn-block" href="/stories/new?chid={{challenge.id}}" id="challenge-link" type="button"><span class="glyphicon glyphicon-pencil"></span> Accept Challenge!</a>
      {% endif %}          
          
          {% if owner %}
          <!-- <a class="btn btn-info btn-block" href="/challenges/edit/{{challenge.id}}/" id="challenge-link" type="button"><span class="glyphicon glyphicon-pencil"></span> Edit challenge</a> -->
          {% endif %}
          <ul class="list-unstyled" id="story-stats">
            <li id="pubdate">Challenge created: {{challenge.ctime|date:"jS F Y"}}</li>
            <li id="startdate">{% if not challenge.started %}Challenge starts: {% else %}Challenge started:{% endif %} {{challenge.stime|date:"jS F Y"}}</li>
            <li id="enddate">{% if challenge.ended %}Challenge ended: {% else %}Challenge ends:{% endif %} {{challenge.etime|date:"jS F Y"}}</li>
          </ul>
          <hr />
          
          {% if challenge.ended and challenge.winner %}
          <h2>Winning Story</h2>

          <h4 class="entry_title">{{challenge.winner|story_link}}</h4>

		  <ul class="challenge-story-winner">
			<li>{{ challenge.winner.user|author_span }}</li>
			<li>Posted <abbr class="published" title="{{s.ptime|date:'Y-m-d'}}">{{challenge.winner.ptime|age}}</abbr></li>
		  </ul>          
          <hr />
          {% endif %}
          <p class="small" id="licence">All challenges on Ficlatt&eacute; are licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">Creative Commons Attribution-Share Alike 3.0 License</a>. <a href="http://wiki.creativecommons.org/Sharing_Creative_Works">What does this mean?</a></p>
          <hr />
          <h2>Comments <small>({{challenge|num_comments}} so far!)</small></h2>
          <ul class="challenge-comments">
			{% for comment in comments %}
			<li class="challenge-comment">
				{{comment.user|author_link:'h4'}}
				{{comment.body|encode_story}}
				<ul class="list-inline">
					<li class="posted">Posted <abbr class="dtposted" title="{{comment.ctime|date:'Y-m-d'}}">{{comment.ctime|age}}</abbr></li>
				</ul>
			</li>
			{% endfor %}
          </ul>
          <hr />
          {% if profile %}
          <div id="comment-box">
            <form action="/comment/submit/" id="comment-form" method="post" role="form">
              {% csrf_token %}
              <input id="comment_sid" name="chid" type="hidden" value="{{challenge.id}}" />
              <div class="form-group">
                  <label class="control-label" for="comment_body">Leave a comment</label>
                  <textarea class="form-control" id="comment_body" maxlength="1024" name="body" rows="7"></textarea>
              </div> <!-- id="" class="form-group" -->
              <div class="form-group">
                <input alt="Submit comment" type="submit" value="Submit" />
              </div> <!-- id="" class="form-group" -->
            </form>
          </div> <!-- id="comment-box" class="" -->
          {% endif %}
  {% endif %}
          
{% endblock secondary_panel %}
